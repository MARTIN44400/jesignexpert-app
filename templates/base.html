{% extends "base.html" %}

{% block title %}Accueil - JeSignExpert{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-pen"></i> JeSignExpert - Intégration API
        </h1>
    </div>
</div>

<!-- État de la configuration -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Configuration
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <strong>URL ECMA :</strong><br>
                        <code>{{ config.base_url }}</code>
                    </div>
                    <div class="col-sm-6">
                        <strong>Shortcut :</strong><br>
                        <code>{{ config.shortcut }}</code>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-6">
                        <strong>Environnement :</strong><br>
                        <span class="badge bg-info">{{ config.environment }}</span>
                    </div>
                    <div class="col-sm-6">
                        <strong>Secret ECMA :</strong><br>
                        {% if secret_configured %}
                            <span class="badge bg-success">Configuré</span>
                        {% else %}
                            <span class="badge bg-danger">Non configuré</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions principales -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Actions
                </h5>
            </div>
            <div class="card-body">
                {% if not tokens %}
                    <!-- Authentification -->
                    <a href="{{ url_for('authenticate') }}" class="btn btn-success btn-lg w-100 mb-2">
                        <i class="bi bi-box-arrow-in-right"></i> S'authentifier
                    </a>
                    <small class="text-muted">Connexion via ComptExpert</small>
                {% else %}
                    <!-- Actions authentifiées -->
                    <a href="{{ url_for('send_document_page') }}" class="btn btn-primary w-100 mb-2">
                        <i class="bi bi-send-fill"></i> Envoyer un document
                    </a>
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="showCreateTransaction()">
                        <i class="bi bi-plus-circle"></i> Créer transaction simple
                    </button>
                    <a href="{{ url_for('validate_tokens') }}" class="btn btn-outline-secondary w-100 mb-2">
                        <i class="bi bi-check-circle"></i> Valider tokens
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if tokens %}
<!-- Informations de connexion -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-check"></i> Session active
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Cabinet :</strong><br>
                        {{ tokens.office.name }}
                        {% if tokens.office.token %}
                            <span class="badge bg-success ms-2">Token valide</span>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Utilisateur :</strong><br>
                        {% if tokens.user and tokens.user.email %}
                            {{ tokens.user.email }}
                            {% if tokens.user.token %}
                                <span class="badge bg-success ms-2">Token valide</span>
                            {% endif %}
                        {% else %}
                            <em class="text-muted">Non défini</em>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-text"></i> Transactions
                </h5>
                <button class="btn btn-primary btn-sm" onclick="showCreateTransaction()">
                    <i class="bi bi-plus"></i> Nouvelle
                </button>
            </div>
            <div class="card-body">
                {% if transactions and transactions|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Créée le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td><code>{{ transaction.id[:8] }}...</code></td>
                                    <td>{{ transaction.object or transaction.name or 'Sans nom' }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ transaction.type or 'signature' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ transaction.status or 'draft' }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ transaction.created_at or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewTransaction('{{ transaction.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">Aucune transaction créée</p>
                        <button class="btn btn-primary" onclick="showCreateTransaction()">
                            Créer ma première transaction
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Création Transaction -->
<div class="modal fade" id="createTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTransactionForm">
                    <div class="mb-3">
                        <label for="transactionName" class="form-label">Nom de la transaction</label>
                        <input type="text" class="form-control" id="transactionName" name="name" required maxlength="45">
                        <div class="form-text">Maximum 45 caractères</div>
                    </div>
                    <div class="mb-3">
                        <label for="transactionMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="transactionMessage" name="message" rows="3" maxlength="4000"></textarea>
                        <div class="form-text">Maximum 4000 caractères</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="invitationMode" class="form-label">Mode d'invitation</label>
                                <select class="form-select" id="invitationMode" name="invitationMode">
                                    <option value="sequential">Séquentiel</option>
                                    <option value="parallel">Parallèle</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="locked" name="locked" checked>
                                <label class="form-check-label" for="locked">
                                    Verrouiller les documents
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confidential" name="confidential">
                                <label class="form-check-label" for="confidential">
                                    Transaction confidentielle
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createTransaction()">
                    <i class="bi bi-plus-circle"></i> Créer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function showCreateTransaction() {
    {% if not tokens %}
        alert('Vous devez d\'abord vous authentifier pour créer une transaction.');
        return;
    {% endif %}
    
    const modal = new bootstrap.Modal(document.getElementById('createTransactionModal'));
    modal.show();
}

function createTransaction() {
    const form = document.getElementById('createTransactionForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        message: formData.get('message') || 'Transaction créée depuis l\'interface web',
        invitationMode: formData.get('invitationMode') || 'sequential',
        locked: formData.has('locked'),
        confidential: formData.has('confidential')
    };
    
    fetch('/transaction/init', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erreur: ' + data.error);
        } else {
            alert('Transaction créée avec succès !');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la création de la transaction');
    });
}

function viewTransaction(id) {
    alert('Fonctionnalité de visualisation à implémenter pour la transaction: ' + id);
}
</script>
{% endblock %}